<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
     <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156554032-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-156554032-1');
</script>

	<title>Online Diary/journal</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="refresh" />
    
	<meta name="description" content="The number one free journal and diary with 100% privacy and is available offline." />
    
	<meta name="keywords" content="online diary, online journal, free diary with total privacy, online bible study tool, group bible study" />
    
	<meta name="author" content="Geoffrey Kibera Ngure" />
    
    <script data-ad-client="ca-pub-6607329542714309" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

    <!--bootstrap-->
	<link rel="stylesheet" type="text/css" href="./boot/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="./boot/bootstrap-grid.min.css" />
	<link rel="stylesheet" type="text/css" href="./boot/bootstrap-reboot.min.css" />

	<!--normal css-->
    <link rel="stylesheet" type="text/css" href="./css/footer.css" />
    <link rel="stylesheet" type="text/css" href="./css/main.css" />
    <link rel="stylesheet" type="text/css" href="./css/actions.css" />
    <link rel="stylesheet" type="text/css" href="./css/widgEditor.css">

    <!--favicon-->
    <link rel="apple-touch-icon" sizes="57x57" href="./favicon/apple-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="./favicon/apple-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="./favicon/apple-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="./favicon/apple-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="./favicon/apple-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="./favicon/apple-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="./favicon/apple-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="./favicon/apple-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-icon-180x180.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="./favicon/android-icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="./favicon/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png" />

    <meta name="msapplication-TileColor" content="#00ffaa" />
    <meta name="msapplication-TileImage" content="./favicon/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ccffee" />

    <link rel="manifest" href="manifest.json" />

    <script type="text/javascript" src="./scripts/widgEditor.js"></script>

    <!--fonts-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bangers|Roboto+Mono|Indie+Flower&display=swap">
    
</head>

<body>

    <div id="anotherB" class="flexible">
        <div id="main-btns" >
				<div class="bar11"></div>
				<div class="bar12"></div>
				<div class="bar13"></div>
        </div>
        <div id="silo1">
            <button class="linkers1 close-icon" style="color: red;">&times;</button> 
            <button class="linkers1 write">Write</button> 
            <button class="linkers1 reader">Read</button>
            <button class="linkers1 offlinereader">Read Unsaved</button>
            <a href="/logout" ><button class="linkers1">Logout</button></a> 
            <a href="../" ><button class="linkers1">Visit Homepage</button></a> 

        </div>
        <div class="flexible">
            <p class="dated"></p>
            <!--<p class="timed"></p>-->
        </div>
    </div>

    <div id="logoutarea" class="row" style="background-color: #00ffaa;">
        <div class="col-sm-2 flexible">
            <!--write name of the user-->
        </div>
        <div class="col-sm-2 flexible">
            <p class="dated"></p>
        </div>
        <div class="col-sm-2 flexible">
            <button id="write" class="write btn btn-primary btn-block">Write..</button>
        </div>
        <div class="col-sm-2 flexible">
            <button id="reader" class="reader btn btn-primary btn-block">Read..</button>
        </div>
        <div class="col-sm-2 flexible">
            <button id="" class="offlinereader btn btn-primary btn-block">Read offline</button>
        </div>
        <div class="col-sm-2 flexible">
            <a href="/logout"><button class="btn btn-danger btn-block">logout!</button></a>
        </div>
    </div>

    <div id="identifier" class="flexible" >
        <!--write name of the user-->
        <p id="identified" ></p>
        <p id="displayMessage" ></p>
        <p id="displayError" ></p>
    </div>
    
    <div id="diary" style="padding-top:10px;">
        <form action="/myentry" onSubmit="return validateForm(this)" method="post" role="form">
            <label>Please write a subject before saving...</label>
                <!--<input id="timer" type="hidden" name="timer" value=""; />-->
                <input id="dated" type="hidden" name="dated" value=""; />
                <input id="timed" type="hidden" name="timed" value=""; />
            <div class="flexible form-group">
                <input id="mtitle" class="form-control col-sm-4 mx-auto" type="text" name="title" placeholder="subject" />
            </div>
            <div class="form-group">
                <textarea id="noise" name="secret" class="widgEditor form-control mx-auto" placeholder="This is your writing area..."></textarea>
            </div>
		  
			<div class="form-group">
                <input type="submit" id="submitW" name="submitW" value="SAVE!" class="btn btn-primary btn-block col-sm-3 mx-auto" />
            </div>
		</form>  
    </div>
    
    
    
    
    <div class="container-fluid">
        <div class="row" style="margin-top: 25px; width: 100%;">
            <div class="col-sm-10 offset-sm-1 col-12 flexible">
                <div class="card writearea hidden ">
                    <div class="card-body ">
                        <div class="row" >
                            <div class="col-sm-3 offset-sm-4 col-md-2 offset-md-5 col-6 offset-3">
                                <button class="btn btn-warning col-sm-3 btn-block closeicon">close</button>
                            </div>
                        </div>
                        <br />
                        <hr />
                        <h4 class="card-title">my entries...</h4>
                        <br />
                        <hr />
                        <p class="card-text" id="writtenC"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="read" class="flexible hidden offsetted">
        <div class="table-responsive">
			<table class="table table-condensed">
				<thead>
    			    <tr>
    				    <th>DATE</th>
                        <th>Subject</th>
                        <th>Action</th>
                    </tr>
                </thead>
    		    <tbody id="tableBodyOn">

                </tbody>
        
            </table>
        </div>
    </div>

    <div id="offlineread" class="flexible hidden offsetted">
        <a href="/ofllinesave" id="offlinesave" class="btn btn-primary">Save all...</a>
        <div class="table-responsive">
			<table class="table table-condensed">
				<thead>
    			    <tr>
    				    <th>DATE</th>
                        <th>Subject</th>
                        <th>Action</th>
                    </tr>
                </thead>
    		    <tbody id="tableBodyOff">

                </tbody>
        
            </table>
        </div>
    </div>
    
    
    <div style="margin-top:100px;"></div>

    <div id="footer" style="position:fixed; bottom:0;">
        <small>
            copyright &copy; 2020 | 
            <a href="http://finitecreations.co.ke"> powered by finite creations</a>
        </small>
    </div>

	

	<script type="text/javascript" src="./scripts/jquery.min.js"></script>    
    <script type="text/javascript" src="./scripts/validator.js"></script>
    <script type="text/javascript" src="./scripts/indexedDB.js"></script>
    <script type="text/javascript" src="./scripts/webpush.js"></script>
    <script type="text/javascript" src="./scripts/sha1encryption.js"></script>
    
	<script type="text/javascript">
        
        
        (function(){
            if('serviceWorker' in navigator){
                navigator.serviceWorker.register("sw.js").then(initialiseState);
		    }else{
		 	    console.log("serviceWorker not supported");
            }
        })();

       /* if('serviceWorker' in navigator){
		 	navigator.serviceWorker.register("sw.js").then(reg=>{
		 		console.log("serviceWorker registration successful with scope: ", reg.scope);
		 	}).catch(err=>{
		 		console.log("serviceWorker registration failed with reason: ", err);
		 	});
		}else{
		 	console.log("serviceWorker not supported");
        }*/
        
       /*if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg=>navigator.serviceWorker.ready).then(registration => {
                console.log("serviceWorker registration successful with scope: ", registration.scope);
                console.log(registration);
                registration.pushManager.getSubscription().then(subscription => {
                    if (subscription) {
                        console.log("already subscribed");
                        return;
                    }
                    console.log("registering");
                    var options={
                        userVisibleOnly: true, 
                        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                    };
                    return registration.pushManager.subscribe(options).then(subscription => {
                        console.log("subscribed1");
                        var rawKey = subscription.getKey ? subscription.getKey('p256dh') : '';
                        console.log("subscribed2");
                        key = rawKey ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawKey))) : '';
                        console.log("subscribed2");
                        var rawAuthSecret = subscription.getKey ?  subscription.getKey('auth') : '';
                        console.log("subscribed3");
                        authSecret = rawAuthSecret ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawAuthSecret))) : '';
                        console.log("subscribed4");
                        endpoint = subscription.endpoint;
                        console.log("subscribed");

                        return fetch('./register', {
                            method: 'post',
                            headers: new Headers({'content-type': 'application/json'}),
                            body: JSON.stringify({
                                endpoint: subscription.endpoint,
                                key: key,
                                authSecret: authSecret,
                            }),
                        }).then(res=>{
                            console.log(res);
                        });
                    });
                })
            }).catch(function(err) {// registration failed :(
                console.log('ServiceWorker registration failed: ', err);
            });
        } */
        
        $(document).ready(function(){
            var id=localStorage.getItem('id');
            var username=localStorage.getItem('username');
            var permuser=localStorage.getItem('permanentUsername');
            var permid=localStorage.getItem('permanentId');
            if(id!==null && username !== null && id === permid && username === permuser){
                $("#identified").html("Welcome back "+username);
                console.log(id);
                console.log(username);
            }
            else{
                 $("#identified").html("You must be loged in to access this page. Redirecting...");
                window.location.href="/login";
            }
            //setTimeout(loader, 2000);
            
            $(".reader").click(function(){
                if($("#read").hasClass("hidden")){
                    $("#read").removeClass("hidden");
                    //$("#writtenC").removeClass("hidden");
                }
                if(!$("#diary").hasClass("hidden")){
                    $("#diary").addClass("hidden");
                }
                if(!$("#offlineread").hasClass("hidden")){
                    $("#offlineread").addClass("hidden");
                }
                
                onlinereader();
                /*$.post("diaryserver.php", {read:"yes"}, function(data){
                    $("#read").html(data);
                })  */  
            });
            
            $(".closeicon").click(function(){
                $(".writearea").addClass("hidden");
            });
            

            $(".offlinereader").click(function(event){
                console.log(event);
                //store for offline is subject
                var dataread=allReader("subject");
                console.log(dataread);
                if(!$("#read").hasClass("hidden")){
                    $("#read").addClass("hidden");
                }
                if(!$("#diary").hasClass("hidden")){
                    $("#diary").addClass("hidden");
                }
                if($("#offlineread").hasClass("hidden")){
                    $("#offlineread").removeClass("hidden");
                    //$("#writtenC").removeClass("hidden");
                }
                
               /* $.post("diaryserver.php", {read:"yes"}, function(data){
                    $("#read").html(data);
                })  */ 
            });

            $(".write").click(function(){
                if(!$("#read").hasClass("hidden")){
                    $("#read").addClass("hidden");
                }
                if($("#diary").hasClass("hidden")){
                    $("#diary").removeClass("hidden");
                    //$("#writtenC").addClass("hidden");
                }
                if(!$("#offlineread").hasClass("hidden")){
                    $("#offlineread").addClass("hidden");
                }
                    
            }); 

            $("#main-btns").click(function(){
                    var toip=$("#silo1").css('display');
                    if(toip=="none"){
                        reveal();
                    }else if(toip=="block"){
                        hider();
                    }
            });

            $(".linkers1").click(function(event){
                var toip=$("#silo1").css('display');
                if(toip=="block"){
                    setTimeout(hider, 1000);
                }
            });

           /* $("div").doubleclick(function(event){
                var toip=$("#silo1").css('display');
                if(toip=="block"){
                    setTimeout(hider, 1000);   
                }
            });*/
         });

        function offreader(event){
            var readid=event.target.id
            console.log(readid);
            console.log(event);
            $(".writearea").removeClass("hidden");
            searchItems("entries", readid);
        }
        
        function serverreader(event){
            var readid=event.target.id
            console.log(readid);
            console.log(event);
            $(".writearea").removeClass("hidden");
            searchItems("onlineEntries", readid);
        }
        
         var day=new Date();
            var date=day.toDateString();
            var time=day.toTimeString();
            console.log(date);
            console.log(time);
            $(".timed").html(time);
            $(".dated").html(date);
        
        function reveal(){
            $("#silo1").css('width', '65%');
            $("#silo1").css('display', 'block');
        }
    

        function hider(){
            $("#silo1").css('width', '0');
            $("#silo1").css('display', 'none');

         }
        
        function onlinereader(){
            var apps={
                id: localStorage.getItem('id'),
                username: localStorage.getItem('username')
            };
            fetch("/onlineread", {
                method: 'POST',
                headers: new Headers({'content-type': 'application/json'}),
                body: JSON.stringify(apps)
            }).then(res=>{
                if(res.status!==200){
                    throw "there was an error communicating with the server. please try again later";
                }
                ondbClear("onlineSubject", "onlineEntries");
                return res.json();
                
            }).then(res=>{
                res.forEach(value=>{
                    var onlineSub={
                        date: value.date,
                        subject: value.subject
                    }
                    //console.log(value);
                    ondbWriter(onlineSub, value);
                });
                //console.log(res);
                onReader("onlineSubject");
                
            }).catch(err=>{
               console.log(err); 
            });
        }
        
        function formatDate(dayOfWeek, day, month, year) {
            var daysOfWeek = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
            var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; 
            return daysOfWeek[dayOfWeek] + " " + months[month] + " " + day + " " + year;
        }
        
        function dategetter(){
            var today=new Date();
            var day=today.getUTCDay();
            var date=today.getUTCDate();
            var month=today.getUTCMonth();
            var year=today.getFullYear();
            
            return formatDate(day, date, month, year);
        }
        function timegetter(){
            var timer=new Date();
            var hour=timer.getHours();
            var minutes=timer.getMinutes();
            var sec=timer.getSeconds();
            
            return hour+":"+minutes+":"+sec;
            
        }
         
            
    function validateForm(form){
        var day=new Date();
        //var date=day.toDateString();
        var date=dategetter();
        //var time=day.toTimeString();
        var time=timegetter();

        $("#dated").val(date);
        $("#timed").val(time);
        
        var diaryEntry={
            id: localStorage.getItem('id'),
            date: $("#dated").val(),
            time: $("#timed").val(),
            subject: $("#mtitle").val(),
            message: $("#noise").val()  
        }
        
        var fail="";
        fail = validateSubject(diaryEntry.subject);
        fail += validateMessage(diaryEntry.message);
        //fail += validateSurname(form.subject.value);

        if(fail==""){
            fetch("/diaryinput", {
                method:'POST',
				headers:new Headers({'content-type':'application/json'}),
				body:JSON.stringify(diaryEntry)
            }).then(response=>{
                if(response.status!==200){
                    throw "There was an error communicating to the server. Your data has been stored locally.";
                }
                console.log(response.status);
                //displayMessage("message sent...");
                return response.text();
            }).then(response=>{
                displayMessage(response);
                returning();
            }).catch(err=>{
                var subject={
                    date:$("#dated").val(),
                    subject:$("#mtitle").val(),
                }
                var entries={
                    date: $("#dated").val(),
                    time: $("#timed").val(),
                    subject: $("#mtitle").val(),
                    mywrite: $("#noise").val()  
                } 
                dbWriter(subject, entries);
                //dbWriter("message", mess1);
                console.log(err);
                displayMessage("data has been saved locally. \n Ensure you send to the server to ensure permanent storage");
                returning();
            });
                   		
        }else{
            alert(fail); 
            
        }
        return false;
    }

    function displayMessage(msg){
        alert(msg);
    }
    function returning(){
        $("#mtitle").val(""),
        $("#noise").val("")            
       
    }

    if(navigator.online){
	 	console.log("you are online");
	}else{
	 	console.log("you are offline");
	}
        
            	
	</script>
    
	
</body>
</html>